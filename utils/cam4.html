<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Explainer Video Recorder</title>
<script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
<style>
  body, html {
    margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif;
    background: #f0f0f0;
  }
  #main {
    position: relative;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    background: #000;
  }
  #bg-image {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    filter: brightness(0.9);
  }
  #pdf-canvas {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    max-width: 80%; max-height: 80%;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transition: all 0.4s ease;
  }
  #webcam-video {
    position: absolute;
    object-fit: cover;
    border-radius: 10px;
    border: 2px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    transition: all 0.4s ease;
  }
  #controls {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(255,255,255,0.95);
    padding: 10px 12px;
    border-radius: 8px;
    z-index: 1000;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  button, input {
    margin: 2px;
    padding: 6px 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background: #2b6cb0;
    color: white;
    font-size: 13px;
  }
  button:disabled { background: #aaa; cursor: not-allowed; }
  #timer { font-weight: bold; color: red; margin-left: 5px; }
</style>
</head>
<body>

<div id="controls">
  <input type="file" id="bg-upload" accept="image/*" title="Background" />
  <input type="file" id="pdf-upload" accept="application/pdf" title="Upload PDF" />
  <button id="prev-page">◀</button>
  <button id="next-page">▶</button>
  <button id="layout-btn">View Layout</button>
  <button id="start-record">Start Record</button>
  <button id="stop-record" disabled>Stop</button>
  <span id="timer">02:00</span>
</div>

<div id="main">
  <div id="bg-image"></div>
  <canvas id="pdf-canvas"></canvas>
  <video id="webcam-video" autoplay muted></video>
</div>

<script>
let pdfDoc = null, pageNum = 1;
const pdfCanvas = document.getElementById("pdf-canvas");
const ctx = pdfCanvas.getContext("2d");
let recorder, screenStream, cameraStream;
let timerInterval, timeLeft = 120;
let layoutIndex = 0;
const webcam = document.getElementById("webcam-video");

// === Background Upload ===
document.getElementById("bg-upload").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    document.getElementById("bg-image").style.backgroundImage = `url(${reader.result})`;
  };
  reader.readAsDataURL(file);
});

// === PDF Handling ===
document.getElementById("pdf-upload").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const fileReader = new FileReader();
  fileReader.onload = function() {
    const typedarray = new Uint8Array(this.result);
    pdfjsLib.getDocument(typedarray).promise.then((pdf) => {
      pdfDoc = pdf;
      pageNum = 1;
      renderPage(pageNum);
    });
  };
  fileReader.readAsArrayBuffer(file);
});

function renderPage(num) {
  pdfDoc.getPage(num).then((page) => {
    const viewport = page.getViewport({ scale: 1.5 });
    pdfCanvas.height = viewport.height;
    pdfCanvas.width = viewport.width;
    const renderCtx = { canvasContext: ctx, viewport: viewport };
    page.render(renderCtx);
  });
}

document.getElementById("prev-page").onclick = () => {
  if (pdfDoc && pageNum > 1) renderPage(--pageNum);
};
document.getElementById("next-page").onclick = () => {
  if (pdfDoc && pageNum < pdfDoc.numPages) renderPage(++pageNum);
};

// === Layout Cycling ===
document.getElementById("layout-btn").onclick = () => {
  layoutIndex = (layoutIndex + 1) % 5;
  updateLayout();
};

function updateLayout() {
  const pdf = pdfCanvas;
  const cam = webcam;
  cam.style.borderRadius = "10px"; // default
  switch (layoutIndex) {
    case 0: // 1. Side-by-side rectangles
      pdf.style.maxWidth = "45%";
      pdf.style.maxHeight = "80%";
      pdf.style.left = "30%";
      cam.style.width = "45%";
      cam.style.height = "80%";
      cam.style.left = "75%";
      cam.style.top = "50%";
      cam.style.transform = "translate(-50%, -50%)";
      cam.style.borderRadius = "10px";
      break;
    case 1: // 2. Left PDF, tall webcam right
      pdf.style.maxWidth = "55%";
      pdf.style.left = "30%";
      cam.style.width = "25%";
      cam.style.height = "90%";
      cam.style.left = "80%";
      cam.style.top = "50%";
      cam.style.transform = "translate(-50%, -50%)";
      cam.style.borderRadius = "10px";
      break;
    case 2: // 3. Left PDF, right circular webcam
      pdf.style.maxWidth = "55%";
      pdf.style.left = "30%";
      cam.style.width = "200px";
      cam.style.height = "200px";
      cam.style.left = "80%";
      cam.style.top = "50%";
      cam.style.transform = "translate(-50%, -50%)";
      cam.style.borderRadius = "50%";
      break;
    case 3: // 4. Large PDF, small rectangle webcam bottom
      pdf.style.maxWidth = "80%";
      pdf.style.left = "50%";
      cam.style.width = "250px";
      cam.style.height = "150px";
      cam.style.left = "50%";
      cam.style.top = "90%";
      cam.style.transform = "translate(-50%, -50%)";
      cam.style.borderRadius = "10px";
      break;
    case 4: // 5. Large PDF, small circle webcam bottom
      pdf.style.maxWidth = "80%";
      pdf.style.left = "50%";
      cam.style.width = "180px";
      cam.style.height = "180px";
      cam.style.left = "50%";
      cam.style.top = "88%";
      cam.style.transform = "translate(-50%, -50%)";
      cam.style.borderRadius = "50%";
      break;
  }
}

// === Recording ===
async function startRecording() {
  document.documentElement.requestFullscreen();
  screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
  cameraStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

  webcam.srcObject = cameraStream;

  const finalStream = new MediaStream([
    ...screenStream.getVideoTracks(),
    ...cameraStream.getVideoTracks(),
    ...cameraStream.getAudioTracks()
  ]);

  recorder = RecordRTC(finalStream, { type: "video" });
  recorder.startRecording();

  document.getElementById("start-record").disabled = true;
  document.getElementById("stop-record").disabled = false;

  startTimer();
}

function stopRecording() {
  clearInterval(timerInterval);
  recorder.stopRecording(() => {
    recorder.save("explainer-video.webm");
  });
  screenStream.getTracks().forEach(t => t.stop());
  cameraStream.getTracks().forEach(t => t.stop());
  document.exitFullscreen();
  document.getElementById("start-record").disabled = false;
  document.getElementById("stop-record").disabled = true;
  document.getElementById("timer").textContent = "02:00";
  timeLeft = 120;
}

function startTimer() {
  timeLeft = 120;
  timerInterval = setInterval(() => {
    timeLeft--;
    let m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
    let s = String(timeLeft % 60).padStart(2, '0');
    document.getElementById("timer").textContent = `${m}:${s}`;
    if (timeLeft <= 0) stopRecording();
  }, 1000);
}

document.getElementById("start-record").onclick = startRecording;
document.getElementById("stop-record").onclick = stopRecording;
</script>
</body>
</html>
