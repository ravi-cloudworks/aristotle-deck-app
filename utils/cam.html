<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Explainer Video Recorder</title>
<script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
<style>
  body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: sans-serif; }
  #container { display: flex; height: 100vh; width: 100vw; }
  #pdf-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f5f5f5; }
  #pdf-canvas { width: 90%; border: 1px solid #ccc; }
  #controls { position: fixed; top: 10px; left: 10px; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  #webcam { flex: 1; display: flex; align-items: center; justify-content: center; background: black; }
  video { width: 90%; border-radius: 10px; }
  button { margin: 5px; padding: 8px 12px; }
  #timer { font-weight: bold; color: red; }
</style>
</head>
<body>

<div id="controls">
  <input type="file" id="pdf-upload" accept="application/pdf" />
  <button id="prev-page">Prev</button>
  <button id="next-page">Next</button>
  <button id="start-record">Start Record Explainer Video</button>
  <button id="stop-record" disabled>Stop</button>
  <span id="timer">02:00</span>
</div>

<div id="container">
  <div id="pdf-container">
    <canvas id="pdf-canvas"></canvas>
  </div>
  <div id="webcam">
    <video id="webcam-video" autoplay muted></video>
  </div>
</div>

<script>
let pdfDoc = null, pageNum = 1, pdfCanvas = document.getElementById("pdf-canvas"), ctx = pdfCanvas.getContext("2d");
let recorder, screenStream, cameraStream, mixedStream;
let timerInterval, timeLeft = 120; // 2 minutes

// === PDF Handling ===
document.getElementById("pdf-upload").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const fileReader = new FileReader();
  fileReader.onload = function() {
    const typedarray = new Uint8Array(this.result);
    pdfjsLib.getDocument(typedarray).promise.then((pdf) => {
      pdfDoc = pdf;
      pageNum = 1;
      renderPage(pageNum);
    });
  };
  fileReader.readAsArrayBuffer(file);
});

function renderPage(num) {
  pdfDoc.getPage(num).then((page) => {
    const viewport = page.getViewport({ scale: 1.5 });
    pdfCanvas.height = viewport.height;
    pdfCanvas.width = viewport.width;
    const renderCtx = { canvasContext: ctx, viewport: viewport };
    page.render(renderCtx);
  });
}

document.getElementById("prev-page").onclick = () => {
  if (pdfDoc && pageNum > 1) renderPage(--pageNum);
};
document.getElementById("next-page").onclick = () => {
  if (pdfDoc && pageNum < pdfDoc.numPages) renderPage(++pageNum);
};

// === Recording Setup ===
async function startRecording() {
  document.documentElement.requestFullscreen();
  screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
  cameraStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

  document.getElementById("webcam-video").srcObject = cameraStream;

  // Merge screen + camera
  const finalStream = new MediaStream([
    ...screenStream.getVideoTracks(),
    ...cameraStream.getVideoTracks(),
    ...cameraStream.getAudioTracks()
  ]);

  recorder = RecordRTC(finalStream, { type: "video" });
  recorder.startRecording();

  document.getElementById("start-record").disabled = true;
  document.getElementById("stop-record").disabled = false;

  startTimer();
}

function stopRecording() {
  clearInterval(timerInterval);
  recorder.stopRecording(() => {
    recorder.save("explainer-video.webm");
  });
  screenStream.getTracks().forEach(t => t.stop());
  cameraStream.getTracks().forEach(t => t.stop());
  document.exitFullscreen();
  document.getElementById("start-record").disabled = false;
  document.getElementById("stop-record").disabled = true;
  document.getElementById("timer").textContent = "02:00";
  timeLeft = 120;
}

function startTimer() {
  timeLeft = 120;
  timerInterval = setInterval(() => {
    timeLeft--;
    let m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
    let s = String(timeLeft % 60).padStart(2, '0');
    document.getElementById("timer").textContent = `${m}:${s}`;
    if (timeLeft <= 0) stopRecording();
  }, 1000);
}

document.getElementById("start-record").onclick = startRecording;
document.getElementById("stop-record").onclick = stopRecording;
</script>
</body>
</html>
